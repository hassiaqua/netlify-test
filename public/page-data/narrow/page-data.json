{"componentChunkName":"component---src-templates-post-js","path":"/narrow/","result":{"data":{"wordpressPost":{"id":"2411eddc-2ab8-56d2-a691-3a15dc20c5f9","title":"WordPressに独自のGETパラメータを追加して「絞り込み検索」をする方法","slug":"narrow","content":"<p>チェックボックスで選択された選択肢から絞り込むという「絞り込み検索」の作り方です。</p>\n<p>GETパラメーターを追加して、<code>WP_Query</code>で取得したGETパラメータから任意のループを作るというやり方になります。ただし、WordPressでGETパラメーターはあらかじめ許可されたものしか利用できないので、ここの追加方法も見ていきましょう。</p>\n<div class=\"chat\"><figure class=\"chat-img\"><img src=\"https://haniwaman.com/wp-content/themes/hpcode/img/haniwa.png\" alt=\"\"><figcaption>はにわまん</figcaption></figure><div class=\"chat-content\">絞り込む方法はそれほど難しくはありません。</div></div>\n<div id=\"toc_container\" class=\"no_bullets\"><p class=\"toc_title\">目次</p><ul class=\"toc_list\"><li><a href=\"#WordPress\"><span class=\"toc_number toc_depth_1\">1</span> WordPressで絞り込み検索をする方法</a><ul><li><a href=\"#i\"><span class=\"toc_number toc_depth_2\">1.1</span> 検索フォームを作成</a></li><li><a href=\"#GET\"><span class=\"toc_number toc_depth_2\">1.2</span> GETパラメーターを許可</a></li><li><a href=\"#WP_Query\"><span class=\"toc_number toc_depth_2\">1.3</span> WP_Queryで絞り込み</a></li><li><a href=\"#8230\"><span class=\"toc_number toc_depth_2\">1.4</span> 値が元に戻る&#8230;</a></li></ul></li><li><a href=\"#i-2\"><span class=\"toc_number toc_depth_1\">2</span> おわり</a></li></ul></div>\n<h2><span id=\"WordPress\">WordPressで絞り込み検索をする方法</span></h2>\n<p>今回はチェックボックスとキーワードから「絞り込み」検索する方法を紹介していこうと思います。</p>\n<h3><span id=\"i\">検索フォームを作成</span></h3>\n<p><code>name</code>の値は、GETパラメーターの値。<code>value</code>はカテゴリーのスラッグ名としています。</p>\n<pre><span class=\"code-copy\" data-clipboard-target=\"#code-0\">コピー</span><code id=\"code-0\" class=\"html\">&lt;form method=\"get\" action=\"\"&gt;\r\n\t&lt;input type=\"search\" value=\"\" placeholder=\"検索キーワードを入力\" name=\"my-keyword\"&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat1\" value=\"wordpress\" checked&gt;&lt;span&gt;WordPress&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat2\" value=\"html\" checked&gt;&lt;span&gt;HTML&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat3\" value=\"css\" checked&gt;&lt;span&gt;CSS&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat4\" value=\"javascript\" checked&gt;&lt;span&gt;JavaScript&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;button type=\"submit\"&gt;検索する&lt;/button&gt;\r\n&lt;/form&gt;</code></pre>\n<p>CSSなどはご自身のお好みで調整してほしいのですが、以下のような要素が揃います。<br />\n<img src=\"https://haniwaman.com/wp-content/uploads/2019/06/narrow1-1-700x153.png\" alt=\"\" width=\"700\"  class=\"alignnone size-medium wp-image-15490\" srcset=\"https://haniwaman.com/wp-content/uploads/2019/06/narrow1-1-700x153.png 700w, https://haniwaman.com/wp-content/uploads/2019/06/narrow1-1-768x168.png 768w, https://haniwaman.com/wp-content/uploads/2019/06/narrow1-1-1200x262.png 1200w, https://haniwaman.com/wp-content/uploads/2019/06/narrow1-1.png 1656w\" sizes=\"(max-width: 700px) 100vw, 700px\" /></p>\n<p>またこの状態で「検索する」ボタンを押すと、</p>\n<p><code>?my-keyword=&amp;my-cat1=wordpress&amp;my-cat2=html&amp;my-cat3=css&amp;my-cat4=javascript</code>といった文字がURLに付与されることが分かると思います。これがGETパラメーターで「s」とか「my-cat2」のイコールに続く値を遷移先などで使うことができるようになるものです。</p>\n<h3><span id=\"GET\">GETパラメーターを許可</span></h3>\n<p>フォームのGETパラメーターで値は取得できるのですが、WordPressは許可されたGETパラメーター以外はループ処理（<code>WP_Query</code>）で使わせてくれません。</p>\n<p>ですので、<code>query_vars</code>のフィルターを使って、下記のようにフォームの<code>name</code>属性で追加した分だけGETパラメーターを許可してあげてください。</p>\n<pre><span class=\"filename\">functions.php</span><span class=\"code-copy\" data-clipboard-target=\"#code-1\">コピー</span><code id=\"code-1\" class=\"php\">function my_query_vars( $vars ) {\r\n\t$vars[] = 'my-keyword';\r\n\t$vars[] = 'my-cat1';\r\n\t$vars[] = 'my-cat2';\r\n\t$vars[] = 'my-cat3';\r\n\t$vars[] = 'my-cat4';\r\n\treturn $vars;\r\n}\r\nadd_filter( 'query_vars', 'my_query_vars' );</code></pre>\n<p>公式だと下記の記事の「カスタムクエリ変数」のあたりを参考にしてもらえたらと思います。<br />\n→ <a href=\"https://wpdocs.osdn.jp/%E9%96%A2%E6%95%B0%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9/get_query_var\" rel=\"noopener nofollow\" target=\"_blank\">関数リファレンス/get query var &#8211; WordPress Codex 日本語版</a></p>\n<h3><span id=\"WP_Query\"><code>WP_Query</code>で絞り込み</span></h3>\n<p>今回作成した検索フォームだと絞り込むときの条件としては下記のようにすればOKです。<strong class=\"marker\">GETパラメーターの値をどうやって取得するか</strong>と、<strong class=\"marker\">「WP_Query」の使い方</strong>の2つを理解していれば扱えるようになります。</p>\n<pre><span class=\"code-copy\" data-clipboard-target=\"#code-2\">コピー</span><code id=\"code-2\" class=\"php\">$my_cat = array();\r\nfor ( $i = 1; $i &lt;= 4; $i++ ) {\r\n\t$my_cat[] = get_query_var( 'my-cat' . $i );\r\n}\r\n$my_query = new WP_Query(\r\n\tarray(\r\n\t\t'post_type' =&gt; 'post',\r\n\t\t's'         =&gt; get_query_var( 'my-keyword' ),\r\n\t\t'tax_query' =&gt; array(\r\n\t\t\tarray(\r\n\t\t\t\t'taxonomy' =&gt; 'category',\r\n\t\t\t\t'field'    =&gt; 'slug',\r\n\t\t\t\t'terms'    =&gt; $my_cat,\r\n\t\t\t),\r\n\t\t),\r\n\t\t'paged'     =&gt; get_query_var( 'paged', 1 ),\r\n\t)\r\n);</code></pre>\n<h4>GETパラメーターの取得</h4>\n<p>WordPressでGETパラメーターの値を取得するには<code>get_query_var()</code>という関数を使います。WordPressはPHPで標準に用意されている<code>$_GET</code>などは使わせずに、独自の関数を用意していることが多いので、極力はWordPressが用意した関数を使うようにすると安全です。</p>\n<p>今回取得すべき値としては、以下の2パターンですね。</p>\n<ul class=\"check\">\n<li>検索キーワードの「my-keyword」</li>\n<li>カテゴリーのスラッグ名の「my-cats1」〜「my-cats4」</li>\n</ul>\n<p>カテゴリーについてはループで配列に入れてあげて、<code>WP_Query</code>の<code>terms</code>に入れています。この辺は<code>WP_Query</code>の仕様に合わせて使うようにしてください。</p>\n<h4>「WP_Query」の使い方</h4>\n<p>WP_Queryで独自のループを作成することをサブループと呼んだりします。今回のやっていることを日本語で言うと、「投稿の記事から検索キーワードが〇〇でカテゴリーが〇〇の記事を取得してください」といった感じです。<code>paged</code>に関しては、何ページ目かを示しているもので、2ページ目や3ページ目などが必要な一覧ページの場合は指定する必要があります。</p>\n<p>サブループついて詳しくは下記の記事で解説しているので、参考にしてもらえたらと思います。</p>\n<blockquote class=\"wp-embedded-content\" data-secret=\"lPj3UnEfh7\"><p><a href=\"https://haniwaman.com/loop/\">WordPressの任意のループ（サブループ）を作る方法と覚えておきたい指定方法</a></p></blockquote>\n<p><iframe title=\"&#8220;WordPressの任意のループ（サブループ）を作る方法と覚えておきたい指定方法&#8221; &#8212; HPcode\" class=\"wp-embedded-content\" sandbox=\"allow-scripts\" security=\"restricted\" style=\"position: absolute; clip: rect(1px, 1px, 1px, 1px);\" src=\"https://haniwaman.com/loop/embed/#?secret=lPj3UnEfh7\" data-secret=\"lPj3UnEfh7\" width=\"500\" height=\"282\" frameborder=\"0\" marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\"></iframe></p>\n<h3><span id=\"8230\">値が元に戻る&#8230;</span></h3>\n<p>今のまま遷移するとチェックボックスの値やテキストエリアの値が初期化されてしまいます。UI的にはフォームを選択した遷移後は、操作したときの値でそのまま残っておいてほしいものです&#8230;</p>\n<pre><span class=\"code-copy\" data-clipboard-target=\"#code-3\">コピー</span><code id=\"code-3\" class=\"php\">&lt;form method=\"get\" action=\"\"&gt;\r\n\t&lt;input type=\"search\" value=\"&lt;?php echo esc_attr( get_query_var( 'my-keyword' ) ); ?&gt;\" placeholder=\"カテゴリーで絞り込む\" name=\"my-keywor\"&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat1\" value=\"wordpress\" &lt;?php echo get_query_var( 'my-cat1' ) ? 'checked' : ''; ?&gt;&gt;&lt;span&gt;WordPress&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat2\" value=\"html\" &lt;?php echo get_query_var( 'my-cat2' ) ? 'checked' : ''; ?&gt;&gt;&lt;span&gt;HTML&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbx\" name=\"my-cat3\" value=\"css\" &lt;?php echo get_query_var( 'my-cat3' ) ? 'checked' : ''; ?&gt;&gt;&lt;span&gt;CSS&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;label&gt;&lt;input type=\"checkbox\" name=\"my-cat4\" value=\"javascript\" &lt;?php echo get_query_var( 'my-cat4' ) ? 'checked' : ''; ?&gt;&gt;&lt;span&gt;JavaScript&lt;/span&gt;&lt;/label&gt;\r\n\t&lt;button type=\"submit\"&gt;検索する&lt;/button&gt;\r\n&lt;/form&gt;</code></pre>\n<p>上記のように、GETパラメーターの値でチェック有無やテキストボックスの値を管理すると、遷移後もいい感じに残ってくれたりします。<br />\n<video src=\"https://haniwaman.com/wp-content/uploads/2019/06/narrow2.mov\" controls autoplay loop></video></p>\n<h2><span id=\"i-2\">おわり</span></h2><div class=\"matome\"><div class=\"matome-img\"><img src=\"https://haniwaman.com/wp-content/themes/hpcode/img/haniwa.png\" alt=\"\"></div><div class=\"matome-twitter\"><a href=\"https://twitter.com/haniwa008?ref_src=twsrc%5Etfw\" class=\"twitter-follow-button\" data-show-screen-name=\"false\" data-size=\"large\" data-lang=\"ja\" data-show-count=\"true\">Follow @haniwa008</a><script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script></div></div><!-- /matome -->\n<p>WordPressに独自のGETパラメータを追加して「絞り込み検索」をする方法でした。</p>\n<p>今回はカテゴリーだけでしたが、この考え方さえ理解すれば、<strong class=\"marker\">タグを追加したり、独自のタームを追加したりとカスタマイズはいくらでもできるようになってきます</strong>。</p>\n<p>絞り込み検索ができるようになると、ちょっとしたオリジナルなポータルサイト（賃貸検索するやつとか飲食店検索するやつなど）も抵抗なく作るれるようになってくるはずです。</p>\n<p>こういう実装も気軽にできるのがPHPとMySQLで作られているWordPressのメリットだったりするので、普通にサイト作るだけでなくサービスにも目を向けてみるとよりWordPressを楽しめるかもしれません！</p>\n","date":"June 26, 2019","categories":[{"name":"WordPress","slug":"wordpress"}],"tags":null,"author":{"name":"はにわまん","slug":"haniwaman"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"2411eddc-2ab8-56d2-a691-3a15dc20c5f9"}}}