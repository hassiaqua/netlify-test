{"componentChunkName":"component---src-templates-post-js","path":"/rakuten-api/","result":{"data":{"wordpressPost":{"id":"a3072c84-f9eb-51c2-bc3f-9f98e611a4e7","title":"楽天商品検索APIの使い方－最安値の商品を見つけよう（PHP）－","slug":"rakuten-api","content":"<p>楽天商品検索APIの使い方を紹介していきます！</p>\n<p>楽天サービスはたくさんサービスがあって<a href=\"https://webservice.rakuten.co.jp/document/\" target=\"_blank\">たくさんのAPI</a>が存在するのですが、本エントリーではおそらくみなさんが一番利用するであろう商品検索APIの使い方について取り上げました。</p>\n<p>WEB APIというものは基本的には、使い方はどれも同じで、<br />\nサービス本体（ここでは楽天）のサーバーへリクエスト（URL）を投げて、結果を返してもらうといったものです。</p>\n<p>今回は、楽天のサーバーへリクエストを送るために必須となる、アプリIDとアフィリエイトIDの取得方法について紹介していきます。</p>\n<div class=\"chat\"><figure class=\"chat-img\"><img src=\"https://haniwaman.com/wp-content/themes/hpcode/img/haniwa.png\" alt=\"\"><figcaption>はにわまん</figcaption></figure><div class=\"chat-content\">楽天のAPIはシンプルでとても使いやすいです！</div></div>\n<div id=\"toc_container\" class=\"no_bullets\"><p class=\"toc_title\">目次</p><ul class=\"toc_list\"><li><a href=\"#ID\"><span class=\"toc_number toc_depth_1\">1</span> アプリIDを取得</a></li><li><a href=\"#API\"><span class=\"toc_number toc_depth_1\">2</span> 楽天商品検索APIの必須パラメーター確認</a><ul><li><a href=\"#i\"><span class=\"toc_number toc_depth_2\">2.1</span> すべての商品からキーワード検索を行う</a></li></ul></li><li><a href=\"#i-2\"><span class=\"toc_number toc_depth_1\">3</span> 最安値を求めるのに必要そうなパラメーター</a></li><li><a href=\"#URL\"><span class=\"toc_number toc_depth_1\">4</span> リクエストURLの作り方</a></li><li><a href=\"#i-3\"><span class=\"toc_number toc_depth_1\">5</span> コードを書いていきましょう！</a><ul><li><a href=\"#API-2\"><span class=\"toc_number toc_depth_2\">5.1</span> 楽天商品検索APIのサンプルコード</a></li><li><a href=\"#PHP\"><span class=\"toc_number toc_depth_2\">5.2</span> PHPの動作環境が必要</a></li><li><a href=\"#i-4\"><span class=\"toc_number toc_depth_2\">5.3</span> 結果の内容を見ることが大事</a></li></ul></li><li><a href=\"#i-5\"><span class=\"toc_number toc_depth_1\">6</span> おわり</a></li></ul></div>\n<h2><span id=\"ID\">アプリIDを取得</span></h2>\n<p>楽天ウェブサービスヘアクセス<br />\n→<a href=\"http://webservice.rakuten.co.jp/\" target=\"_blank\">http://webservice.rakuten.co.jp/</a></p>\n<p>アプリID発行をクリック！<br />\n<img class=\"alignnone size-full wp-image-7486\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api.png\" alt=\"rakuten_api\" width=\"972\" height=\"508\" /><br />\nもしくは、→<a href=\"https://webservice.rakuten.co.jp/app/create\" target=\"_blank\">https://webservice.rakuten.co.jp/app/create</a></p>\n<p>楽天会員としてのログインが求められます。<br />\n普段から楽天ショップなど利用してすでに楽天会員である方は、ユーザーIDとパスワードを入力してログインしてください。</p>\n<p>まだ、楽天会員でない方は、右上の新規登録から楽天会員になる必要があります。（新規登録の流れは省きますが、アナウンス通りに手順に進んでいけば難しく無いはずです。）<br />\n楽天会員になったらまたこのページに戻ってきてログインしてください。</p>\n<p><img class=\"alignnone size-full wp-image-7487\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_2.png\" alt=\"rakuten_api_2\" width=\"775\" height=\"445\" /></p>\n<p>楽天APIを利用するアプリケーションを指定します。<br />\n当ブログ「HPcode」で使うための申請なら以下のような感じです。</p>\n<p><img class=\"alignnone size-full wp-image-7488\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_3.png\" alt=\"rakuten_api_3\" width=\"752\" height=\"648\" /></p>\n<p>「規約に同意して新規アプリを作成する」ボタンを押すと、以下のように、アプリが登録されます！<br />\n<img class=\"alignnone size-full wp-image-7490\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_4.png\" alt=\"rakuten_api_4\" width=\"748\" height=\"584\" /></p>\n<p>ここの情報は、楽天のWeb APIを利用する上でめちゃくちゃ重要なものです。</p>\n<p>楽天ウェブサービスにログインすればいつでも見れるので特にメモする必要はありませんが、<br />\n特に「アプリID」は必ず利用するくらいに思っておいてください。</p>\n<h2><span id=\"API\">楽天商品検索APIの必須パラメーター確認</span></h2>\n<p>楽天商品検索APIの必須パラメーターを確認しておきましょう。<br />\n→<a href=\"https://webservice.rakuten.co.jp/api/ichibaitemsearch/\" target=\"_blank\">https://webservice.rakuten.co.jp/api/ichibaitemsearch/</a></p>\n<p>「入力パラメーター」あたりを見てもらうと分かりますが、「アプリID」に「○」が付いていて必須になっているのが分かります。<br />\n<img class=\"alignnone size-large wp-image-7492\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_5-700x457.png\" alt=\"rakuten_api_5\" width=\"546\" height=\"356\" /></p>\n<p>その他に必須の項目を探してスクロールしていくと、「検索キーワード」「ショップコード」「商品コード」「ジャンルID」に「○」が付いており、その下には「※1」とあります。</p>\n<blockquote><p>(*1)検索キーワード、ジャンルID、商品コード、ショップコードのいずれかが指定されていることが必須です。</p></blockquote>\n<p>とありますので、「検索キーワード」「ショップコード」「商品コード」「ジャンルID」のどれか1つが指定されていることが必須であって、全部を指定する必要はありません。</p>\n<p>ということで、楽天商品検索APIで必須のパラメーターは、「アプリID」と「検索キーワード、ショップコード、商品コード、ジャンルID」の中から1つ以上ということが分かりました。</p>\n<h3><span id=\"i\">すべての商品からキーワード検索を行う</span></h3>\n<p>今回作成するサービスは、すべての商品から「キーワード」で商品を検索するようにしようと思います。<br />\nということで、「検索キーワード、ショップコード、商品コード、ジャンルID」の中からは、「検索キーワード」だけ利用します。</p>\n<p>つまり、今回に限って言えば必須のパラメーターは「アプリID」と「検索キーワード」ということになりますね。</p>\n<h2><span id=\"i-2\">最安値を求めるのに必要そうなパラメーター</span></h2>\n<p>必須のパラメーターは分かりましたが、今回やりたいのは最安値の商品を探すことです。<br />\nそこで、最安値を調べられそうなパラメーターをピックアップしていきましょう。</p>\n<ul>\n<li>ソート</li>\n<li>最小価格</li>\n</ul>\n<p>この2つがあれば、十分そうですね。<br />\n<img class=\"alignnone size-large wp-image-7493\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_7-700x457.png\" alt=\"rakuten_api_7\" width=\"546\" height=\"356\" /></p>\n<p>まぁ、ソートだけで結果を価格の安い順に並べ替えてくれるのですが、なんか楽天って0円とか1円とかの無駄に安すぎる怪しい商品が上の方に出てきたりするので、<br />\nそういうのは、「最小価格」で弾いてやりたいと思ってます。</p>\n<h2><span id=\"URL\">リクエストURLの作り方</span></h2>\n<p>必須のURLが分かったところでリクエストURLの作り方を見ていきましょう。<br />\n<img class=\"alignnone size-full wp-image-7494\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_8.png\" alt=\"rakuten_api_8\" width=\"738\" height=\"121\" /></p>\n<p>リクエストURLのルールは以下の2点。</p>\n<ul>\n<li><code>https://app.rakuten.co.jp/services/api/IchibaItem/Search/20140222?[parameter]=[value]&amp;[parameter2]=[value2]&amp;[parameter3]=[value3]・・・</code>の形式であること。</li>\n<li>パラメーター「keyword」とパラメーター「sort」の値は、UTF-8でエンコードすること。</li>\n</ul>\n<p>UTF-8のエンコーディングはプログラムの中でやるとして、今回のパラメーターを使ってリクエストURLを作ると以下のようになります（※イメージ）。</p>\n<blockquote><p>https://app.rakuten.co.jp/services/api/IchibaItem/Search/20140222?applicationId=[自分のアプリID]&amp;keyword=[UTF-8でエンコーディングされた任意のキーワード]&amp;sort=[+itemPrice（これもUTF-8でエンコーディング）]&amp;minPrice=10（10円以上で設定しようと思います）</p></blockquote>\n<p>といった感じです。</p>\n<p>これを楽天のサーバーに投げて結果を受け取り、プログラムで必要な情報をブラウザに表示されるといった流れになります。</p>\n<h2><span id=\"i-3\">コードを書いていきましょう！</span></h2>\n<p>なんとなく、リクエストURLなるものを作って楽天のサーバーにアクセスするということが分かったかと思います。</p>\n<p>たぶん、いろいろ説明するよりも実際のコードを見て、自分で動かしながら確認したほうが理解が早いと思うので、早速コードを書いていきましょう！</p>\n<h3><span id=\"API-2\">楽天商品検索APIのサンプルコード</span></h3>\n<pre><span class=\"code-copy\" data-clipboard-target=\"#code-0\">コピー</span><code id=\"code-0\" class=\"html\">&lt;!DOCTYPE html&gt;\r\n&lt;html lang=&#039;ja&#039;&gt;\r\n&lt;head&gt;\r\n&lt;title&gt;楽天商品検索API テスト&lt;/title&gt;\r\n&lt;meta charset=&#039;utf-8&#039;&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;?php\r\n$rakuten_relust = getRakutenResult(&#039;進撃の巨人&#039;, 1000); // キーワードと最低価格を指定\r\nforeach ($rakuten_relust as $item) :\r\n?&gt;\r\n&lt;div style=&#039;margin-bottom: 20px; padding: 30px; border: 1px solid #000; overflow:hidden;&#039;&gt;\r\n &lt;div style=&#039;float: left;&#039;&gt;&lt;img src=&#039;&lt;?php echo $item[&#039;img&#039;]; ?&gt;&#039;&gt;&lt;/div&gt;\r\n &lt;div style=&#039;float: left; padding: 20px;&#039;&gt;\r\n &lt;div&gt;&lt;?php echo $item[&#039;name&#039;]; ?&gt;&lt;/div&gt;\r\n &lt;div&gt;&lt;a href=&#039;&lt;?php echo $item[&#039;url&#039;]; ?&gt;&#039; target=&quot;_blank&quot;&gt;&lt;?php echo $item[&#039;url&#039;]; ?&gt;&lt;/a&gt;&lt;/div&gt;\r\n &lt;div&gt;&lt;?php echo $item[&#039;price&#039;]; ?&gt;円&lt;/div&gt;\r\n &lt;div&gt;&lt;?php echo $item[&#039;shop&#039;]; ?&gt;&lt;/div&gt;\r\n &lt;/div&gt;\r\n&lt;/div&gt;\r\n&lt;?php\r\nendforeach;\r\n?&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n \r\n&lt;?php \r\n\r\nfunction getRakutenResult($keyword, $min_price) {\r\n\r\n// ベースとなるリクエストURL\r\n$baseurl = &#039;https://app.rakuten.co.jp/services/api/IchibaItem/Search/20140222&#039;;\r\n// リクエストのパラメータ作成\r\n$params = array();\r\n$params[&#039;applicationId&#039;] = &#039;[自分のアプリID]&#039;; // アプリID\r\n$params[&#039;keyword&#039;] = urlencode_rfc3986($keyword); // 任意のキーワード。※文字コードは UTF-8\r\n$params[&#039;sort&#039;] = urlencode_rfc3986(&#039;+itemPrice&#039;); // ソートの方法。※文字コードは UTF-8\r\n$params[&#039;minPrice&#039;] = $min_price; // 最低価格\r\n\r\n$canonical_string=&#039;&#039;;\r\n\r\nforeach($params as $k =&gt; $v) {\r\n    $canonical_string .= &#039;&amp;&#039; . $k . &#039;=&#039; . $v;\r\n}\r\n// 先頭の&#039;&amp;&#039;を除去\r\n$canonical_string = substr($canonical_string, 1);\r\n\r\n// リクエストURL を作成\r\n$url = $baseurl . &#039;?&#039; . $canonical_string;\r\n\r\n// XMLをオブジェクトに代入\r\n$rakuten_json=json_decode(@file_get_contents($url, true));\r\n\r\n$items = array();\r\nforeach($rakuten_json-&gt;Items as $item) {\r\n    $items[] = array(\r\n                    &#039;name&#039; =&gt; (string)$item-&gt;Item-&gt;itemName,\r\n                    &#039;url&#039; =&gt; (string)$item-&gt;Item-&gt;itemUrl,\r\n                    &#039;img&#039; =&gt; isset($item-&gt;Item-&gt;mediumImageUrls[0]-&gt;imageUrl) ? (string)$item-&gt;Item-&gt;mediumImageUrls[0]-&gt;imageUrl : &#039;&#039;,\r\n                    &#039;price&#039; =&gt; (string)$item-&gt;Item-&gt;itemPrice,\r\n                    &#039;shop&#039; =&gt; (string)$item-&gt;Item-&gt;shopName,\r\n                    );\r\n}\r\n\r\nreturn $items;\r\n}\r\n\r\n// RFC3986 形式で URL エンコードする関数\r\nfunction urlencode_rfc3986($str) {\r\n    return str_replace(&#039;%7E&#039;, &#039;~&#039;, rawurlencode($str));\r\n}?&gt;</code></pre>\n<p>36行目は、今回作成したご自身のアプリIDを入力します。</p>\n<p>10行目の「進撃の巨人」や「1000」の値は好きな値に変えてください。<br />\n（変えながら動作を確認してください。）</p>\n<p>実行すると以下のような感じになります。（cssつけて最低限のデザインはしました。）<br />\n<img class=\"alignnone size-large wp-image-7498\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_9-700x523.png\" alt=\"rakuten_api_9\" width=\"546\" height=\"408\" /></p>\n<h3><span id=\"PHP\">PHPの動作環境が必要</span></h3>\n<p>このコードはPHPで書かれています。<br />\n動作を確認するためにはPHPの動作環境が必要です。</p>\n<p>もし手元にPHPの動作環境がなければ、ローカル（自分のパソコン）に環境を作っちゃいましょう。<br />\n方法は以下を参考に。</p>\n<blockquote class=\"wp-embedded-content\" data-secret=\"DaSvLYAF9T\"><p><a href=\"https://haniwaman.com/local-apache/\">超簡単！PHPプログラムをローカルで動作確認するための環境構築方法</a></p></blockquote>\n<p><iframe title=\"&#8220;超簡単！PHPプログラムをローカルで動作確認するための環境構築方法&#8221; &#8212; HPcode\" class=\"wp-embedded-content\" sandbox=\"allow-scripts\" security=\"restricted\" style=\"position: absolute; clip: rect(1px, 1px, 1px, 1px);\" src=\"https://haniwaman.com/local-apache/embed/#?secret=DaSvLYAF9T\" data-secret=\"DaSvLYAF9T\" width=\"500\" height=\"282\" frameborder=\"0\" marginwidth=\"0\" marginheight=\"0\" scrolling=\"no\"></iframe></p>\n<h3><span id=\"i-4\">結果の内容を見ることが大事</span></h3>\n<p>今回は取得した内容から選んで分かりやすい形で表示するところまでをわたしが作りました。<br />\n本来であれば、みなさんがレスポンス内容から必要そうなデータを（PHPで）抜き出し、そして見やすい形に（HTMLやCSSで）整形するわけです。</p>\n<p>必要そうなデータを抜き出すときに大事なのが、どういうデータが返ってきているかを知ることです。<br />\n52行目で取得した<code>$rakuten_json</code>を<code>var_dump($rakuten_json)</code>することで確認できます。</p>\n<p>確認したい方は、53行目あたりに<code>var_dump($rakuten_json);</code>を追加してみてください。<br />\n(preで挟んだほうが整形が崩れなくていいかもしれません。)</p>\n<pre><span class=\"code-copy\" data-clipboard-target=\"#code-1\">コピー</span><code id=\"code-1\" class=\"php\">echo &lt;pre&gt;\r\nvar_dump($rakuten_json);\r\necho &lt;/pre&gt;</code></pre>\n<p>見てみるとこんな感じでデータが返ってきてるんだなということが実感できるはずです。<br />\n<img class=\"alignnone size-large wp-image-7501\" src=\"https://haniwaman.com/wp-content/uploads/2016/01/rakuten_api_10-473x700.png\" alt=\"rakuten_api_10\" width=\"473\" height=\"700\" /></p>\n<h2><span id=\"i-5\">おわり</span></h2><div class=\"matome\"><div class=\"matome-img\"><img src=\"https://haniwaman.com/wp-content/themes/hpcode/img/haniwa.png\" alt=\"\"></div><div class=\"matome-twitter\"><a href=\"https://twitter.com/haniwa008?ref_src=twsrc%5Etfw\" class=\"twitter-follow-button\" data-show-screen-name=\"false\" data-size=\"large\" data-lang=\"ja\" data-show-count=\"true\">Follow @haniwa008</a><script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script></div></div><!-- /matome -->\n<p>楽天APIを利用するためのアプリIDの取得や基本的な操作方法は理解できたのではないでしょうか。<br />\n今回はほんの触り程度です。</p>\n<p>楽天検索APIだけとってもまだまだ利用していないパラメーターもたくさんあります。<br />\n<a href=\"https://webservice.rakuten.co.jp/api/ichibaitemsearch/\" target=\"_blank\">https://webservice.rakuten.co.jp/api/ichibaitemsearch/</a>と睨めっこしつつ、楽天の検索サービスを利用して自分が作りたいものがあればどんどん作っていきましょう！</p>\n<p>言うまでもなく、実際に自分でコードを書いて実行していくことで理解していきますよ！</p>\n","date":"December 24, 2017","categories":[{"name":"Web API","slug":"web-api"}],"tags":null,"author":{"name":"はにわまん","slug":"haniwaman"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"id":"a3072c84-f9eb-51c2-bc3f-9f98e611a4e7"}}}